version: '3.9'
networks:
    airflow_network_v4:
        driver: bridge
services:
    airflow_db_v4:
        image: postgres:16.4
        env_file:
            - ./secrets/airflow_db_env
        logging:
            driver: "json-file"
            options:
                max-size: "2048m"
        ports:
            - "5433:5432"
        restart: unless-stopped
        volumes:
            - ./postgres_airflow_db:/var/lib/postgresql/data:rw
        container_name: airflow_db_v4
        networks:
            - airflow_network_v4
    airflow_pgbouncer_v4:
        image: pgbouncer:v1.19.0
        volumes:
            - ./pgbouncer:/opt/pgbouncer
        restart: unless-stopped
        links:
            - airflow_db_v4
            - airflow_results_db_v4
        depends_on:
            airflow_db_v4:
                condition: service_started
            airflow_results_db_v4:
                condition: service_started
        command: ["pgbouncer /opt/pgbouncer/pgbouncer.ini"]
        container_name: airflow_pgbouncer_v4
        logging:
            driver: "json-file"
            options:
                max-size: "2048m"
        ports:
            - "5435:5432"
        networks:
            - airflow_network_v4
    airflow_results_db_v4:
        image: postgres:16.4
        env_file:
            - ./secrets/airflow_results_db_env
        logging:
            driver: "json-file"
            options:
                max-size: "2048m"
        ports:
            - "5434:5432"
        restart: unless-stopped
        volumes:
            - ./postgres_airflow_results_db:/var/lib/postgresql/data:rw
        container_name: airflow_results_db_v4
        networks:
            - airflow_network_v4
    redis_server_v4:
        image: redis:7.4
        logging:
            driver: "json-file"
            options:
                max-size: "2048m"
        ports:
            - "6379:6379"
        restart: unless-stopped
        volumes:
            - ./secrets/redis.conf:/usr/local/etc/redis/redis.conf:ro
            - ./redis_airflow_data:/data:rw
        container_name: redis_server_v4
        command: redis-server /usr/local/etc/redis/redis.conf --appendonly yes
        networks:
            - airflow_network_v4
    airflow_webserver_v4:
        image: airflow:v2.10.4
        env_file:
            - ./secrets/airflow_env
        logging:
            driver: "json-file"
            options:
                max-size: "2048m"
        links:
            - airflow_db_v4
            - airflow_results_db_v4
            - redis_server_v4
            - airflow_pgbouncer_v4
        ports:
            - "8083:8080"
        user: "${AIRFLOW_UID:-50000}:${GID}"
        volumes:
            - ./airflow_v4_logs:/rds/general/user/igf/ephemeral/airflow_v4_logs:rw
            - ./github/data-management-python:/rds/general/project/genomics-facility-archive-2019/live/AIRFLOW/airflow_v4/github/data-management-python:ro
            - ./secrets:/rds/general/project/genomics-facility-archive-2019/live/AIRFLOW/airflow_v4/secrets:ro
            - ./plugin:/rds/general/project/genomics-facility-archive-2019/live/AIRFLOW/airflow_v4/plugin:ro
            - ./ssl_cert/airflow.cert:/SSL/airflow.cert:ro
            - ./ssl_cert/airflow.key:/SSL/airflow.key:ro
            - /home/igf/.ssh/id_rsa:/SSH/id_rsa:ro
        depends_on:
            airflow_db_v4:
                condition: service_started
            airflow_pgbouncer_v4:
                condition: service_started
            airflow_results_db_v4:
                condition: service_started
            redis_server_v4:
                condition: service_started
        restart: unless-stopped
        command: webserver
        container_name: airflow_webserver_v4
        networks:
            - airflow_network_v4
    airflow_scheduler_v4:
        image: airflow:v2.10.4
        env_file:
            - ./secrets/airflow_env
        logging:
            driver: "json-file"
            options:
                max-size: "2048m"
        links:
            - airflow_db_v4
            - airflow_results_db_v4
            - redis_server_v4
            - airflow_pgbouncer_v4
        depends_on:
            airflow_db_v4:
                condition: service_started
            airflow_pgbouncer_v4:
                condition: service_started
            airflow_results_db_v4:
                condition: service_started
            redis_server_v4:
                condition: service_started
            airflow_webserver_v4:
                condition: service_started
        user: "${AIRFLOW_UID:-50000}:${GID}"
        volumes:
            - ./airflow_v4_logs:/rds/general/user/igf/ephemeral/airflow_v4_logs:rw
            - ./github/igf-airflow-hpc:/rds/general/project/genomics-facility-archive-2019/live/AIRFLOW/airflow_v4/github/igf-airflow-hpc:ro
            - ./github/data-management-python:/rds/general/project/genomics-facility-archive-2019/live/AIRFLOW/airflow_v4/github/data-management-python:ro
            - ./secrets:/rds/general/project/genomics-facility-archive-2019/live/AIRFLOW/airflow_v4/secrets:ro
            - ./plugin:/rds/general/project/genomics-facility-archive-2019/live/AIRFLOW/airflow_v4/plugin:ro
            - ./ssl_cert/airflow.cert:/SSL/airflow.cert:ro
            - ./ssl_cert/airflow.key:/SSL/airflow.key:ro
        restart: unless-stopped
        command: scheduler
        container_name: airflow_scheduler_v4
        networks:
            - airflow_network_v4
    airflow_worker_v4:
        image: airflow:v2.10.4
        env_file:
            - ./secrets/airflow_env
        logging:
            driver: "json-file"
            options:
                max-size: "2048m"
        links:
            - airflow_db_v4
            - airflow_results_db_v4
            - airflow_webserver_v4
            - redis_server_v4
            - airflow_scheduler_v4
            - airflow_flower_v4
            - airflow_pgbouncer_v4
        depends_on:
            airflow_db_v4:
                condition: service_started
            airflow_pgbouncer_v4:
                condition: service_started
            airflow_results_db_v4:
                condition: service_started
            redis_server_v4:
                condition: service_started
            airflow_webserver_v4:
                condition: service_started
            airflow_scheduler_v4:
                condition: service_started
            airflow_flower_v4:
                condition: service_started
        user: "${AIRFLOW_UID:-50000}:${GID}"
        volumes:
            - ./airflow_v4_logs:/rds/general/user/igf/ephemeral/airflow_v4_logs:rw
            - ./github/igf-airflow-hpc:/rds/general/project/genomics-facility-archive-2019/live/AIRFLOW/airflow_v4/github/igf-airflow-hpc:ro
            - ./github/data-management-python:/rds/general/project/genomics-facility-archive-2019/live/AIRFLOW/airflow_v4/github/data-management-python:ro
            - ./secrets:/rds/general/project/genomics-facility-archive-2019/live/AIRFLOW/airflow_v4/secrets:ro
            - ./plugin:/rds/general/project/genomics-facility-archive-2019/live/AIRFLOW/airflow_v4/plugin:ro
            - /home/igf/.ssh/id_rsa:/SSH/id_rsa:ro
        restart: unless-stopped
        ports:
            - "8793:8793"
        command: celery worker -q generic --celery-hostname igf-lims
        container_name: airflow_worker_v4
        networks:
            - airflow_network_v4
    airflow_flower_v4:
        image: airflow:v2.10.4
        env_file:
            - ./secrets/airflow_env
        logging:
            driver: "json-file"
            options:
                max-size: "2048m"
        links:
            - airflow_db_v4
            - airflow_results_db_v4
            - redis_server_v4
            - airflow_pgbouncer_v4
        ports:
            - "5555:5555"
        depends_on:
            airflow_db_v4:
                condition: service_started
            airflow_pgbouncer_v4:
                condition: service_started
            airflow_results_db_v4:
                condition: service_started
            redis_server_v4:
                condition: service_started
            airflow_webserver_v4:
                condition: service_started
            airflow_scheduler_v4:
                condition: service_started
        user: "${AIRFLOW_UID:-50000}:${GID}"
        volumes:
            - ./airflow_v4_logs:/rds/general/user/igf/ephemeral/airflow_v4_logs:rw
            - ./github/igf-airflow-hpc:/rds/general/project/genomics-facility-archive-2019/live/AIRFLOW/airflow_v4/github/igf-airflow-hpc:ro
            - ./github/data-management-python:/rds/general/project/genomics-facility-archive-2019/live/AIRFLOW/airflow_v4/github/data-management-python:ro
            - ./secrets:/rds/general/project/genomics-facility-archive-2019/live/AIRFLOW/airflow_v4/secrets:ro
            - ./plugin:/rds/general/project/genomics-facility-archive-2019/live/AIRFLOW/airflow_v4/plugin:ro
        restart: unless-stopped
        command: celery flower
        container_name: airflow_flower_v4
        networks:
            - airflow_network_v4
    airflow_init:
        image: airflow:v2.10.4
        env_file:
            - ./secrets/airflow_env
        environment:
            _AIRFLOW_DB_UPGRADE: 'true'
            _AIRFLOW_WWW_USER_CREATE: 'true'
        user: "${AIRFLOW_UID:-50000}:${GID}"
        links:
            - airflow_db_v4
            - airflow_results_db_v4
            - redis_server_v4
            - airflow_pgbouncer_v4
        depends_on:
            airflow_db_v4:
                condition: service_started
            airflow_pgbouncer_v4:
                condition: service_started
            airflow_results_db_v4:
                condition: service_started
            redis_server_v4:
                condition: service_started
        volumes:
            - ./airflow_v4_logs:/rds/general/user/igf/ephemeral/airflow_v4_logs:rw
            - ./github/igf-airflow-hpc:/rds/general/project/genomics-facility-archive-2019/live/AIRFLOW/airflow_v4/github/igf-airflow-hpc:ro
            - ./github/data-management-python:/rds/general/project/genomics-facility-archive-2019/live/AIRFLOW/airflow_v4/github/data-management-python:ro
            - ./secrets:/rds/general/project/genomics-facility-archive-2019/live/AIRFLOW/airflow_v4/secrets:ro
            - ./plugin:/rds/general/project/genomics-facility-archive-2019/live/AIRFLOW/airflow_v4/plugin:ro
        command: version
        networks:
            - airflow_network_v4