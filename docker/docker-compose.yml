version: '2.2'
networks:
    airflow_network_v2:
        driver: bridge
    airflow_network_host:
        driver: host
services:
    airflow_db_v2:
        image: postgres:14
        env_file:
               - /home/igf/airflow_v2/secrets/airflow_db_env
        ports:
               - "5433:5432"
        restart: always
        volumes:
                - /home/igf/airflow_v2/postgres_airflow_db:/var/lib/postgresql/data:rw
        container_name: airflow_db_v2
        networks:
               - airflow_network_v2
    airflow_results_db_v2:
        image: postgres:14
        env_file:
               - /home/igf/airflow_v2/secrets/airflow_results_db_env
        ports:
               - "5434:5432"
        restart: always
        volumes:
                - /home/igf/airflow_v2/postgres_airflow_results_db:/var/lib/postgresql/data:rw
        container_name: airflow_results_db_v2
        networks:
               - airflow_network_v2
    redis-server_v2:
        image: redis:6.2
        ports:
              - "6379:6379"
        restart: always
        volumes:
               - /home/igf/airflow_v2/secrets/redis.conf:/usr/local/etc/redis/redis.conf:ro
               - /home/igf/airflow_v2/redis_airflow_data:/data:rw
        container_name: redis-server_v2
        command: redis-server /usr/local/etc/redis/redis.conf --appendonly yes
        networks:
               - airflow_network_v2
    airflow_webserver_v2:
        image: apache/airflow:2.2.2
        env_file:
                - /home/igf/airflow_v2/secrets/airflow_env
        links:
                - airflow_db_v2
                - airflow_results_db_v2
                - redis-server_v2
        ports:
                - "8083:8080"
        user: "${AIRFLOW_UID:-50000}:0"
        volumes:
                - /home/igf/airflow_v2/logs:/rds/general/user/igf/ephemeral/airflow_logs/logs:rw
                - /home/igf/airflow_v2/github/igf-airflow-hpc:/rds/general/user/igf/home/data2/airflow_test/github/igf-airflow-hpc:ro
                - /home/igf/airflow_v2/github/data-management-python:/rds/general/user/igf/home/data2/airflow_test/github/data-management-python:ro
                - /home/igf/airflow_v2/secrets:/rds/general/user/igf/home/data2/airflow_test/secrets:ro
                - /home/igf/airflow_v2/plugin:/rds/general/user/igf/home/data2/airflow_test/plugin:ro
                - /home/igf/airflow_v2/ssl_cert/airflow.cert:/SSL/airflow.cert:ro
                - /home/igf/airflow_v2/ssl_cert/airflow.key:/SSL/airflow.key:ro
                - /home/igf/.ssh/id_rsa:/SSH/id_rsa:ro
        depends_on:
                - airflow_db_v2
                - airflow_results_db_v2
                - redis-server_v2
        restart: always
        command: webserver
        container_name: airflow_webserver_v2
        networks:
               - airflow_network_v2
    airflow_scheduler_v2:
        image: apache/airflow:2.2.2
        env_file:
                - /home/igf/airflow_v2/secrets/airflow_env
        links:
                - airflow_db_v2
                - airflow_results_db_v2
                - redis-server_v2
        depends_on:
                - airflow_db_v2
                - airflow_results_db_v2
                - airflow_webserver_v2
                - redis-server_v2
        user: "${AIRFLOW_UID:-50000}:0"
        volumes:
                - /home/igf/airflow_v2/logs:/rds/general/user/igf/ephemeral/airflow_logs/logs:rw
                - /home/igf/airflow_v2/github/igf-airflow-hpc:/rds/general/user/igf/home/data2/airflow_v2/github/igf-airflow-hpc:ro
                - /home/igf/airflow_v2/github/data-management-python:/rds/general/user/igf/home/data2/airflow_v2/github/data-management-python:ro
                - /home/igf/airflow_v2/secrets:/rds/general/user/igf/home/data2/airflow_v2/secrets:ro
                - /home/igf/airflow_v2/plugin:/rds/general/user/igf/home/data2/airflow_v2/plugin:ro
                - /home/igf/airflow_v2/ssl_cert/airflow.cert:/SSL/airflow.cert:ro
                - /home/igf/airflow_v2/ssl_cert/airflow.key:/SSL/airflow.key:ro
        restart: always
        command: scheduler
        container_name: airflow_scheduler_v2
        networks:
               - airflow_network_v2
    airflow_worker_v2:
        image: apache/airflow:2.2.2
        env_file:
                - /home/igf/airflow_v2/secrets/airflow_env
        links:
                - airflow_db_v2
                - airflow_results_db_v2
                - redis-server_v2
                - airflow_flower_v2
        depends_on:
                - airflow_db_v2
                - airflow_results_db_v2
                - airflow_webserver_v2
                - redis-server_v2
                - airflow_scheduler_v2
                - airflow_flower_v2
        ports:
                - "8794:8793"
        user: "${AIRFLOW_UID:-50000}:0"
        volumes:
                - /home/igf/airflow_v2/logs:/rds/general/user/igf/ephemeral/airflow_logs/logs:rw
                - /home/igf/airflow_v2/github/igf-airflow-hpc:/rds/general/user/igf/home/data2/airflow_v2/github/igf-airflow-hpc:ro
                - /home/igf/airflow_v2/github/data-management-python:/rds/general/user/igf/home/data2/airflow_v2/github/data-management-python:ro
                - /home/igf/airflow_v2/secrets:/rds/general/user/igf/home/data2/airflow_v2/secrets:ro
                - /home/igf/airflow_v2/plugin:/rds/general/user/igf/home/data2/airflow_v2/plugin:ro
                - /home/igf/.ssh/id_rsa:/SSH/id_rsa:ro
        restart: always
        command: celery worker -q wells,generic --celery-hostname wells
        container_name: airflow_worker_v2
        networks:
               - airflow_network_v2
               - airflow_network_host
    airflow_flower_v2:
        image: apache/airflow:2.2.2
        env_file:
                - /home/igf/airflow_v2/secrets/airflow_env
        links:
                - airflow_db_v2
                - airflow_results_db_v2
                - redis-server_v2
        ports:
                - "5555:5555"
        depends_on:
                - airflow_db_v2
                - airflow_results_db_v2
                - airflow_webserver_v2
                - redis-server_v2
                - airflow_scheduler_v2
        user: "${AIRFLOW_UID:-50000}:0"
        volumes:
                - /home/igf/airflow_v2/logs:/rds/general/user/igf/ephemeral/airflow_logs/logs:rw
                - /home/igf/airflow_v2/github/igf-airflow-hpc:/rds/general/user/igf/home/data2/airflow_v2/github/igf-airflow-hpc:ro
                - /home/igf/airflow_v2/github/data-management-python:/rds/general/user/igf/home/data2/airflow_v2/github/data-management-python:ro
                - /home/igf/airflow_v2/secrets:/rds/general/user/igf/home/data2/airflow_v2/secrets:ro
                - /home/igf/airflow_v2/plugin:/rds/general/user/igf/home/data2/airflow_v2/plugin:ro
        restart: always
        command: celery flower
        container_name: airflow_flower_v2
        networks:
               - airflow_network_v2
    airflow-init:
        image: apache/airflow:2.2.2
        env_file:
                - /home/igf/airflow_v2/secrets/airflow_env
        environment:
                _AIRFLOW_DB_UPGRADE: 'true'
                _AIRFLOW_WWW_USER_CREATE: 'true'
        user: "${AIRFLOW_UID:-50000}:0"
        links:
                - airflow_db_v2
                - airflow_results_db_v2
                - redis-server_v2
        depends_on:
                - airflow_db_v2
                - airflow_results_db_v2
                - redis-server_v2
        volumes:
                - /home/igf/airflow_v2/logs:/rds/general/user/igf/ephemeral/airflow_logs/logs:rw
                - /home/igf/airflow_v2/github/igf-airflow-hpc:/rds/general/user/igf/home/data2/airflow_v2/github/igf-airflow-hpc:ro
                - /home/igf/airflow_v2/github/data-management-python:/rds/general/user/igf/home/data2/airflow_v2/github/data-management-python:ro
                - /home/igf/airflow_v2/secrets:/rds/general/user/igf/home/data2/airflow_v2/secrets:ro
                - /home/igf/airflow_v2/plugin:/rds/general/user/igf/home/data2/airflow_v2/plugin:ro
        command: version
        networks:
               - airflow_network_v2